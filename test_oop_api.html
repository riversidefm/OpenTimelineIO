<!DOCTYPE html>
<html>
<head>
    <title>OpenTimelineIO - Object-Oriented API Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>OpenTimelineIO - Object-Oriented API Test</h1>
    <div id="output"></div>
    
    <script>
        let opentime, opentimelineio;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            document.getElementById('output').appendChild(div);
        }
        
        function runTests() {
            try {
                log('<h2>üéØ Testing Object-Oriented API</h2>');
                
                // Test Timeline creation
                log('<h3>1. Timeline Creation & Properties</h3>');
                const timeline = new window.OTIO.Timeline("My Amazing Timeline");
                log(`‚úÖ Created timeline: "${timeline.name()}"`, 'success');
                log(`üìã Schema: ${timeline.schema_name()} v${timeline.schema_version()}`, 'info');
                log(`‚è±Ô∏è Duration: ${timeline.duration().value()} @ ${timeline.duration().rate()}fps`, 'info');
                
                // Test Timeline methods
                timeline.set_name("Renamed Timeline");
                log(`‚úÖ Renamed to: "${timeline.name()}"`, 'success');
                
                // Test Clip creation
                log('<h3>2. Clip Creation & Properties</h3>');
                const clip = new window.OTIO.Clip("Hero Shot");
                log(`‚úÖ Created clip: "${clip.name()}"`, 'success');
                log(`üé¨ Enabled: ${clip.enabled()}`, 'info');
                log(`‚è±Ô∏è Duration: ${clip.duration().value()} @ ${clip.duration().rate()}fps`, 'info');
                
                // Test Clip methods
                clip.set_name("Updated Hero Shot");
                clip.set_enabled(true);
                log(`‚úÖ Updated clip: "${clip.name()}", enabled: ${clip.enabled()}`, 'success');
                
                // Test ExternalReference
                log('<h3>3. ExternalReference Creation & Properties</h3>');
                const ref = new window.OTIO.ExternalReference("/path/to/media.mov");
                log(`‚úÖ Created reference: "${ref.target_url()}"`, 'success');
                ref.set_name("Media Reference");
                log(`üìÅ Name: "${ref.name()}"`, 'info');
                log(`üîó Missing: ${ref.is_missing_reference()}`, 'info');
                
                // Test linking clip to reference
                clip.set_media_reference(ref);
                const linkedRef = clip.media_reference();
                if (linkedRef) {
                    log(`‚úÖ Linked clip to reference: "${linkedRef.target_url()}"`, 'success');
                } else {
                    log('‚ö†Ô∏è Reference linking failed', 'error');
                }
                
                // Test Track
                log('<h3>4. Track Creation & Properties</h3>');
                const track = new window.OTIO.Track("Video Track", "Video");
                log(`‚úÖ Created track: "${track.name()}" (${track.kind()})`, 'success');
                track.set_kind("Audio");
                log(`üéµ Changed to: ${track.kind()} track`, 'info');
                
                // Test JSON serialization
                log('<h3>5. JSON Serialization</h3>');
                const timelineJson = timeline.to_json_string();
                const clipJson = clip.to_json_string();
                log('‚úÖ Timeline JSON:', 'success');
                log(`<pre>${JSON.stringify(JSON.parse(timelineJson), null, 2)}</pre>`);
                log('‚úÖ Clip JSON:', 'success');  
                log(`<pre>${JSON.stringify(JSON.parse(clipJson), null, 2)}</pre>`);
                
                // Test proper cleanup
                log('<h3>6. Memory Management</h3>');
                timeline.dispose();
                clip.dispose();
                ref.dispose();
                track.dispose();
                log('‚úÖ All objects properly disposed', 'success');
                
                log('<h2>üéâ All Tests Passed! Object-Oriented API is Working!</h2>', 'success');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // Load WASM modules sequentially
        async function loadModules() {
            try {
                log('Loading OpenTime module...');
                opentime = await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'build-wasm/src/ts-opentimelineio/opentime-bindings/opentime.js';
                    script.onload = () => {
                        Module = {}; // Reset Module for next load
                        resolve(window.Module);
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                log('‚úÖ OpenTime loaded');
                
                log('Loading OpenTimelineIO module...');
                const script2 = document.createElement('script');
                script2.src = 'build-wasm/src/ts-opentimelineio/opentimelineio-bindings/opentimelineio.js';
                script2.onload = () => {
                    log('‚úÖ OpenTimelineIO loaded');
                    
                    // Load wrapper classes
                    const script3 = document.createElement('script');
                    script3.src = 'src/ts-opentimelineio/typescript/wrappers.js';
                    script3.onload = () => {
                        log('‚úÖ Wrapper classes loaded');
                        setTimeout(runTests, 100);
                    };
                    document.head.appendChild(script3);
                };
                document.head.appendChild(script2);
                
            } catch (error) {
                log(`‚ùå Failed to load modules: ${error.message}`, 'error');
            }
        }
        
        // Start loading
        loadModules();
    </script>
</body>
</html> 